@page "/"
@inject NavigationManager NavigationManager
@inject Chatty.Services.DalUser DalUser
@inject Chatty.Services.UserSession UserSession
@using System.Threading.Tasks


<div class="login-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-5 col-lg-4">
                <div class="login-card">
                    <div class="login-header">
                        <h3>Welcome Back</h3>
                    </div>
                    <div class="card-body p-4">
                        <div class="form-group">
                            <label class="form-label" for="username">Username</label>
                            <input @bind="username" 
                                   @bind:event="oninput"
                                   @onkeypress="HandleKeyPress"
                                   id="username" 
                                   type="text" 
                                   class="form-control" 
                                   placeholder="Enter your username"
                                   disabled="@isLoading" />
                            <span class="input-icon">👤</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="password">Password</label>
                            <input @bind="password" 
                                   @bind:event="oninput"
                                   @onkeypress="HandleKeyPress"
                                   id="password" 
                                   type="password" 
                                   class="form-control" 
                                   placeholder="Enter your password"
                                   disabled="@isLoading" />
                            <span class="input-icon">🔒</span>
                        </div>
                        <button @onclick="Login" 
                                class="btn btn-login btn-primary w-100 text-white" 
                                disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span class="spinner"></span>
                                <span>Authenticating...</span>
                            }
                            else
                            {
                                <span>Login</span>
                            }
                        </button>
                        
                        <div class="text-center mt-3">
                            <span class="text-muted">Don't have an account? </span>
                            <a href="signup" class="text-primary font-weight-bold" style="text-decoration: none;">Sign Up</a>
                        </div>
                        
                        @if (showError)
                        {
                            <div class="alert alert-danger mt-3" role="alert">
                                <strong>⚠️ Authentication failed!</strong><br />
                                Please check your credentials and try again.
                            </div>
                        }
                        
                        @if (showSuccess)
                        {
                            <div class="alert alert-success mt-3" role="alert">
                                <strong>✓ Success!</strong> Redirecting to chat...
                            </div>
                        }

                        <div class="demo-info">
                            <h6>Demo Credentials</h6>
                            <small>
                                <strong>User 1:</strong> admin / admin123<br />
                                <strong>User 2:</strong> john / john123<br />
                                <strong>User 3:</strong> alice / alice123
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string username = "";
    private string password = "";
    private bool showError = false;
    private bool showSuccess = false;
    private bool isLoading = false;

    // Dummy hardcoded users
    private readonly Dictionary<string, string> dummyUsers = new()
    {
        { "admin", "admin123" },
        { "john", "john123" },
        { "alice", "alice123" }
    };

    private bool AuthenticateUser(string user, string pass)
    {
        if (string.IsNullOrWhiteSpace(user) || string.IsNullOrWhiteSpace(pass))
            return false;

        // Use mock data
        if (dummyUsers.TryGetValue(user.ToLower(), out var storedPassword) && storedPassword == pass)
        {
             return true;
        }
        
        // Also allow new users registered in Service
        if (DalUser.AuthenticateUser(user, pass).Result) 
        {
            return true;
        }

        return false;
    }

    private async Task Login()
    {
        // Reset states
        showError = false;
        showSuccess = false;
        isLoading = true;

        await Task.Delay(1000); 

        bool isAuthenticated = AuthenticateUser(username, password);

        if (isAuthenticated)
        {
            UserSession.Username = username; // Set Session
            showSuccess = true;
            await Task.Delay(800);
            NavigationManager.NavigateTo("/home"); // Redirect to Home
        }
        else
        {
            showError = true;
            isLoading = false;
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isLoading)
        {
            await Login();
        }
    }
}